name: Build Android

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (optional; used for artifact naming)'
        required: false
      notes:
        description: 'Release notes (optional)'
        required: false
  workflow_call:
    inputs:
      version:
        required: false
        type: string
      notes:
        required: false
        type: string

jobs:
  android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute artifact name
        id: meta
        shell: bash
        run: |
          name=""
          if [ -n "${{ inputs.version }}" ]; then
            name="${{ inputs.version }}"
          elif [ -n "$GITHUB_REF_NAME" ]; then
            name="$GITHUB_REF_NAME"
          else
            name="manual-${GITHUB_RUN_NUMBER}"
          fi
          echo "artifact_name=$name" >> $GITHUB_OUTPUT
          # produce a filename-safe slug (letters, numbers, dot, dash, underscore)
          slug=$(echo "$name" | sed -E 's/[^A-Za-z0-9._-]+/-/g')
          echo "artifact_slug=$slug" >> $GITHUB_OUTPUT

      # Java 17 is required by modern Android Gradle Plugin
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      # Install Android SDK and accept licenses
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK components
        shell: bash
        run: |
          sdkmanager --install "platform-tools" "platforms;android-34" "build-tools;34.0.0"
          yes | sdkmanager --licenses >/dev/null 2>&1 || true

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter pub get
        run: flutter pub get
        shell: bash

      - name: Analyze
        run: flutter analyze
        shell: bash

      # Optional signing (AAB/APK) — requires the following GitHub Secrets:
      #   ANDROID_KEYSTORE_BASE64: base64 of your JKS/keystore file
      #   ANDROID_KEY_ALIAS
      #   ANDROID_KEY_PASSWORD
      #   ANDROID_STORE_PASSWORD
      # If not provided, build will proceed unsigned.
      - name: Prepare signing (if secrets provided)
        shell: bash
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ANDROID_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
        run: |
          set -e
          if [ -n "$ANDROID_KEYSTORE_BASE64" ] && [ -n "$ANDROID_KEY_ALIAS" ] && [ -n "$ANDROID_KEY_PASSWORD" ] && [ -n "$ANDROID_STORE_PASSWORD" ]; then
            echo "Signing secrets detected — preparing keystore & key.properties"
            mkdir -p android/app
            echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/app/upload-keystore.jks
            printf "storePassword=%s\nkeyPassword=%s\nkeyAlias=%s\nstoreFile=upload-keystore.jks\n" \
              "$ANDROID_STORE_PASSWORD" "$ANDROID_KEY_PASSWORD" "$ANDROID_KEY_ALIAS" \
              > android/key.properties
          else
            echo "Signing secrets not provided — building unsigned artifacts"
          fi

      - name: Build APK (never fail)
        id: build_apk
        shell: bash
        run: |
          # Run build but don't fail this step; record exit code for debugging
          set +e
          flutter build apk --target-platform android-arm,android-arm64 --split-per-abi 
          code=$?
          echo "Build exit code: $code"
          echo "build_exit_code=$code" >> $GITHUB_OUTPUT
          # Always succeed; final failure will be decided by artifact verification
          exit 0

      - name: Rename APKs to include tag/version
        if: always()
        shell: bash
        run: |
          set -e
          dir="build/app/outputs/flutter-apk"
          if [ -d "$dir" ]; then
            shopt -s nullglob
            for f in "$dir"/app-*-release.apk; do
              base="$(basename "$f")"
              new="$dir/$(echo "$base" | sed -E "s/^app-/app-${{ steps.meta.outputs.artifact_slug }}-/")"
              if [ "$f" != "$new" ]; then
                echo "Renaming $base -> $(basename "$new")"
                mv "$f" "$new"
              fi
            done
          fi

      - name: List build outputs (debug)
        shell: bash
        run: |
          echo "== build/app/outputs =="
          ls -R build/app/outputs || true
          echo "== android/app/build/outputs =="
          ls -R android/app/build/outputs || true

      - name: Verify APK outputs exist
        shell: bash
        run: |
          set -e
          ls build/app/outputs/flutter-apk/app-*-release.apk >/dev/null 2>&1 || (echo "No release APK found under build/app/outputs/flutter-apk" && exit 1)

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts-multiabi-${{ steps.meta.outputs.artifact_name }}-${{ github.sha }}
          path: |
            build/app/outputs/flutter-apk/app-*-release.apk
          if-no-files-found: error
